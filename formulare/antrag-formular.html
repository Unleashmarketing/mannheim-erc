<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Antrag Eislaufschule - Mannheimer ERC</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* ========================================
       CSS VARIABLES
       ======================================== */
    :root {
      --primary-color: #0062ff;
      --primary-hover: #0052d9;
      --secondary-color: #e4e3d3;
      --dark-bg: #111111;
      --light-bg: #f7f7f2;
      --accent-color: #ff3a29; /* Fehlerfarbe */
      --text-dark: #222222;
      --text-light: #f7f7f7;
      --text-muted: #555555;
      --gray-light: #e0e0e0;
      --gray-medium: #999999;
      --white: #ffffff;
      
      --spacing-xs: 8px;
      --spacing-sm: 16px;
      --spacing-md: 24px;
      --spacing-lg: 40px;
      --spacing-xl: 60px;
      --spacing-2xl: 80px;
      
      --font-family: "Outfit", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --font-family-accent: "Space Grotesk", monospace;
      
      --border-radius-md: 8px;
      --border-radius-lg: 12px;
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
      --transition-base: 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    /* ========================================
       RESET & BASE STYLES
       ======================================== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; font-size: 16px; }
    body {
      font-family: var(--font-family);
      background-color: var(--light-bg);
      color: var(--text-dark);
      line-height: 1.6;
      padding: var(--spacing-lg) 0;
    }

    /* ========================================
       FORM STYLES
       ======================================== */
    .form-container {
      max-width: 900px;
      margin: 0 auto;
      background: var(--white);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    .form-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, #0047b3 100%);
      color: var(--white);
      padding: var(--spacing-2xl) var(--spacing-lg);
      text-align: center;
      position: relative;
    }

    .back-button-top {
      position: absolute;
      top: var(--spacing-md);
      left: var(--spacing-md);
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.15);
      color: var(--white);
      text-decoration: none;
      border-radius: var(--border-radius-md);
      font-weight: 600;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .form-header h1 {
      font-family: var(--font-family-accent);
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: var(--spacing-sm);
    }

    .form-body { padding: var(--spacing-2xl) var(--spacing-lg); }
    .form-section { margin-bottom: var(--spacing-2xl); }
    .form-section h2 {
      font-family: var(--font-family-accent);
      font-size: 1.5rem;
      color: var(--primary-color);
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-sm);
      border-bottom: 3px solid var(--gray-light);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .form-group { display: flex; flex-direction: column; position: relative; }
    .form-group.full-width { grid-column: 1 / -1; }

    label {
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
      font-size: 0.9rem;
    }
    label .required { color: var(--accent-color); }

    input, select {
      padding: 14px 16px;
      border: 2px solid var(--gray-light);
      border-radius: var(--border-radius-md);
      font-size: 1rem;
      transition: var(--transition-base);
      font-family: inherit;
      background-color: var(--white);
      width: 100%;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    /* --- FEHLER STYLES (NEU) --- */
    input.input-error, select.input-error {
      border-color: var(--accent-color) !important;
      background-color: #fff5f5;
    }
    
    .error-message {
      color: var(--accent-color);
      font-size: 0.85rem;
      margin-top: 6px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 5px;
      animation: fadeIn 0.3s ease;
    }
    
    .error-message::before {
      content: "⚠️"; /* Oder FontAwesome Icon */
      font-size: 0.8rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* -------------------------- */

    .checkbox-group {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      background-color: var(--light-bg);
      border-radius: var(--border-radius-md);
    }
    .checkbox-group input { width: 20px; height: 20px; margin-top: 2px; }

    .btn-container {
      display: flex;
      gap: var(--spacing-md);
      justify-content: flex-end;
      margin-top: var(--spacing-2xl);
      padding-top: var(--spacing-lg);
      border-top: 2px solid var(--gray-light);
    }

    button, .btn-secondary {
      padding: 16px 32px;
      border-radius: var(--border-radius-md);
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font-family-accent);
      border: none;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary { background-color: var(--primary-color); color: var(--white); }
    .btn-primary:disabled { background-color: var(--gray-medium); cursor: not-allowed; }
    .btn-secondary { background-color: transparent; border: 2px solid var(--gray-light); color: var(--text-dark); }

    /* Alert Box oben */
    .alert-box {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }
    .alert-box.error { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; }
    .alert-box.success { background: #dcfce7; color: #166534; border: 1px solid #4ade80; }

    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
      .form-body { padding: var(--spacing-md); }
      .btn-container { flex-direction: column-reverse; }
      button, .btn-secondary { width: 100%; text-align: center; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="form-container">
    <div class="form-header">
      <a href="about.html" class="back-button-top">Zurück</a>
      <h1>Antrag Eislaufschule 2026</h1>
      <p>Bitte füllen Sie alle erforderlichen Felder aus</p>
    </div>

    <div class="form-body">
      <div id="generalAlert" class="alert-box"></div>

      <form id="antragForm" novalidate>
        
        <div class="form-section">
          <h2>Persönliche Daten</h2>
          <div class="form-row">
            <div class="form-group">
              <label>Nachname <span class="required">*</span></label>
              <input type="text" name="Name" required>
            </div>
            <div class="form-group">
              <label>Vorname <span class="required">*</span></label>
              <input type="text" name="Vorname" required>
            </div>
          </div>

          <div class="form-group full-width" style="margin-bottom: 24px;">
            <label>Straße und Hausnummer <span class="required">*</span></label>
            <input type="text" name="Straße" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Postleitzahl <span class="required">*</span></label>
              <input type="text" name="PLZ" placeholder="z.B. 68159" maxlength="5" required>
            </div>
            <div class="form-group">
              <label>Wohnort <span class="required">*</span></label>
              <input type="text" name="Wohnort" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Geburtsdatum <span class="required">*</span></label>
              <input type="date" name="Geburtsdatum" required>
            </div>
            <div class="form-group">
              <label>Geschlecht <span class="required">*</span></label>
              <select name="Geschlecht" required>
                <option value="">Bitte wählen</option>
                <option value="M">Männlich</option>
                <option value="W">Weiblich</option>
                <option value="D">Divers</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Staatsangehörigkeit <span class="required">*</span></label>
            <input type="text" name="Staatsangehörigkeit" value="Deutsch" required>
          </div>
        </div>

        <div class="form-section">
          <h2>Kontaktdaten</h2>
          <div class="form-row">
            <div class="form-group">
              <label>Telefon/Mobil <span class="required">*</span></label>
              <input type="tel" name="Telefon/Mobil" placeholder="+49 123 456789" required>
            </div>
            <div class="form-group">
              <label>E-Mail <span class="required">*</span></label>
              <input type="email" name="e-Mail" required>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2>Abteilung</h2>
          <div class="form-row">
            <div class="form-group">
              <label>Abteilung <span class="required">*</span></label>
              <select name="Abteilung" id="abteilung" required>
                <option value="">Bitte wählen</option>
                <option value="Kunstlauf">Eiskunstlauf</option>
                <option value="Schnelllauf">Eisschnelllauf / Shorttrack</option>
              </select>
            </div>
            <div class="form-group">
              <label>Unterabteilung</label>
              <select name="Unterabteilung" id="unterabteilung">
                <option value="">Bitte wählen</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2>Bankverbindung</h2>
          <div class="form-group" style="margin-bottom: 24px;">
            <label>Name des Kreditinstituts <span class="required">*</span></label>
            <input type="text" name="Name Kreditinstitut" required>
          </div>

          <div class="form-group" style="margin-bottom: 24px;">
            <label>Kontoinhaber <span class="required">*</span></label>
            <input type="text" name="Kontoinhaber" required>
          </div>

          <div class="form-group" style="margin-bottom: 24px;">
            <label>IBAN <span class="required">*</span></label>
            <input type="text" name="IBAN" placeholder="DE00 0000 0000 0000 0000 00" required>
          </div>

          <div class="form-group full-width">
            <div class="checkbox-group">
              <input type="checkbox" id="einzug" name="Einzugsermächtigung" required>
              <label for="einzug">
                Ich erteile die Einzugsermächtigung für den Beitragseinzug <span class="required">*</span>
              </label>
            </div>
            <div id="checkbox-error-container"></div> 
          </div>
        </div>

        <div class="btn-container">
          <a href="about.html" class="btn-secondary">Zurück</a>
          <button type="submit" class="btn-primary" id="submitBtn">
            <span id="btnText">Antrag absenden & PDF laden</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;

    // --- DYNAMISCHE UNTERABTEILUNGEN ---
    const abteilungSelect = document.getElementById('abteilung');
    const unterabteilungSelect = document.getElementById('unterabteilung');

    const unterabteilungen = {
      'Kunstlauf': [
        { value: 'Einzel', label: 'Einzel' },
        { value: 'Paarlauf', label: 'Paarlauf' },
        { value: 'Formation', label: 'Formation / Synchron' },
        { value: 'Erwachsene', label: 'Erwachsene' }
      ],
      'Schnelllauf': [
        { value: 'Shorttrack', label: 'Shorttrack' }
      ]
    };

    abteilungSelect.addEventListener('change', function() {
      unterabteilungSelect.innerHTML = '<option value="">Bitte wählen</option>';
      if (this.value && unterabteilungen[this.value]) {
        unterabteilungen[this.value].forEach(option => {
          const opt = document.createElement('option');
          opt.value = option.value;
          opt.textContent = option.label;
          unterabteilungSelect.appendChild(opt);
        });
      }
    });

    // --- VALIDIERUNGS-HELFER ---

    // Zeigt Fehler unter einem Input Feld an
    function showFieldError(inputElement, message) {
        inputElement.classList.add('input-error');
        
        // Prüfen ob schon eine Nachricht da ist
        let errorDiv = inputElement.parentElement.querySelector('.error-message');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            inputElement.parentElement.appendChild(errorDiv);
        }
        errorDiv.textContent = message;
    }

    // Entfernt alle Fehleranzeigen
    function clearValidationErrors() {
        document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        const alertBox = document.getElementById('generalAlert');
        alertBox.style.display = 'none';
        alertBox.className = 'alert-box';
    }

    // IBAN Algorithmus
    function isValidIBAN(iban) {
      const cleanIban = String(iban).toUpperCase().replace(/[^A-Z0-9]/g, '');
      if(cleanIban.length < 15) return false; // Simple Length Check vorab
      
      const code = cleanIban.match(/^([A-Z]{2})(\d{2})([A-Z\d]+)$/);
      if (!code) return false;

      const digits = (code[3] + code[1] + code[2]).replace(/[A-Z]/g, letter => letter.charCodeAt(0) - 55);
      let checksum = digits.slice(0, 2);
      for (let offset = 2; offset < digits.length; offset += 7) {
        const fragment = String(checksum) + digits.substring(offset, offset + 7);
        checksum = parseInt(fragment, 10) % 97;
      }
      return checksum === 1;
    }

    // Email Regex
    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // --- FORM SUBMIT HANDLER ---

    document.getElementById('antragForm').addEventListener('submit', async function(e) {
      e.preventDefault(); // Verhindert das Standard-Neuladen
      clearValidationErrors(); // Alte Fehler löschen

      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      let hasErrors = false;
      let firstErrorField = null;

      const formData = new FormData(this);
      const data = {};

      // 1. SCHRITT: PFLICHTFELDER & FORMATE PRÜFEN
      
      // Wir iterieren über die Form-Elemente, um direkten Zugriff auf das DOM für Fehlermeldungen zu haben
      const elements = this.elements;

      for (let i = 0; i < elements.length; i++) {
          const field = elements[i];
          
          // Ignoriere Buttons und Fieldsets
          if (field.type === 'submit' || field.tagName === 'BUTTON') continue;

          const value = field.value.trim();
          const name = field.name;

          // Daten für später speichern
          if (field.type === 'checkbox') {
             if (field.checked) data[name] = 'ja';
          } else {
             data[name] = value;
          }

          // A) Prüfung auf leere Pflichtfelder
          if (field.hasAttribute('required')) {
              if (field.type === 'checkbox' && !field.checked) {
                  // Spezialfall Checkbox (hat kein direktes parent, sondern checkbox-group)
                  const container = document.getElementById('checkbox-error-container');
                  const msg = document.createElement('div');
                  msg.className = 'error-message';
                  msg.textContent = 'Bitte stimmen Sie der Einzugsermächtigung zu.';
                  container.appendChild(msg);
                  hasErrors = true;
                  if (!firstErrorField) firstErrorField = field;
              } 
              else if (field.type !== 'checkbox' && value === '') {
                  showFieldError(field, 'Dieses Feld ist erforderlich.');
                  hasErrors = true;
                  if (!firstErrorField) firstErrorField = field;
              }
          }

          // B) Spezifische Format-Prüfungen (nur wenn Wert vorhanden)
          if (value !== '') {
              if (name === 'PLZ' && !/^\d{5}$/.test(value)) {
                  showFieldError(field, 'Bitte eine 5-stellige PLZ eingeben.');
                  hasErrors = true;
              }
              if (name === 'e-Mail' && !isValidEmail(value)) {
                  showFieldError(field, 'Ungültige E-Mail-Adresse.');
                  hasErrors = true;
              }
              if (name === 'IBAN' && !isValidIBAN(value)) {
                  showFieldError(field, 'Ungültige IBAN.');
                  hasErrors = true;
              }
          }
      }

      // Falls Fehler gefunden wurden: Abbruch & Scrollen
      if (hasErrors) {
          if (firstErrorField) {
              firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
              firstErrorField.focus();
          }
          return; // STOPP HIER
      }

      // 2. SCHRITT: ALLES OK -> SENDEN & PDF
      submitBtn.disabled = true;
      btnText.textContent = 'Wird verarbeitet...';

      try {
        // A) Senden an Server (E-Mail Versand Backend)
        // WICHTIG: Ersetze '/api/submit-antrag' mit deiner echten URL!
        /* const response = await fetch('/api/submit-antrag', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) throw new Error('Server Fehler');
        */
       
        // Simulierter Erfolg (nimm das raus, wenn dein Server live ist)
        await new Promise(r => setTimeout(r, 1000)); 

        // B) PDF Client-Side Generierung (als Backup/Sofort-Download)
        generatePDF(data);

        // Erfolgsmeldung anzeigen
        const alertBox = document.getElementById('generalAlert');
        alertBox.style.display = 'block';
        alertBox.className = 'alert-box success';
        alertBox.textContent = 'Antrag erfolgreich übermittelt! PDF wird heruntergeladen.';
        alertBox.scrollIntoView({ behavior: 'smooth' });

        setTimeout(() => {
            this.reset();
            submitBtn.disabled = false;
            btnText.textContent = 'Antrag absenden & PDF laden';
            clearValidationErrors();
        }, 3000);

      } catch (error) {
          console.error(error);
          const alertBox = document.getElementById('generalAlert');
          alertBox.style.display = 'block';
          alertBox.className = 'alert-box error';
          alertBox.textContent = 'Fehler beim Senden. Bitte prüfen Sie Ihre Verbindung.';
          submitBtn.disabled = false;
          btnText.textContent = 'Erneut versuchen';
      }
    });

    // --- PDF GENERATOR (UNVERÄNDERT) ---
    function generatePDF(formData) {
      const doc = new jsPDF();
      doc.setFontSize(18); doc.setFont(undefined, 'bold');
      doc.text('Antrag Eislaufschule 2026', 20, 20);
      doc.setFontSize(11); doc.setFont(undefined, 'normal');
      
      let yPos = 35; const lh = 8; const lm = 20;
      
      const printLine = (label, val, isBoldTitle = false) => {
          if(isBoldTitle) { doc.setFont(undefined, 'bold'); doc.text(label, lm, yPos); doc.setFont(undefined, 'normal'); }
          else { doc.text(`${label} ${val}`, lm + 5, yPos); }
          yPos += lh;
      };

      printLine('Persönliche Daten:', '', true);
      printLine('Name:', formData.Name);
      printLine('Vorname:', formData.Vorname);
      printLine('Straße:', formData.Straße);
      printLine('PLZ:', formData.PLZ);
      printLine('Wohnort:', formData.Wohnort);
      printLine('Geburtsdatum:', formData.Geburtsdatum);
      yPos += 5;

      printLine('Kontaktdaten:', '', true);
      printLine('Tel:', formData['Telefon/Mobil']);
      printLine('Email:', formData['e-Mail']);
      yPos += 5;

      printLine('Abteilung:', '', true);
      printLine('Bereich:', formData.Abteilung);
      if(formData.Unterabteilung) printLine('Unterabteilung:', formData.Unterabteilung);
      yPos += 5;

      printLine('Bankverbindung:', '', true);
      printLine('Bank:', formData['Name Kreditinstitut']);
      printLine('IBAN:', formData.IBAN);
      printLine('Inhaber:', formData.Kontoinhaber);
      printLine('Einzug:', 'Ja, erteilt');

      const fileName = `Antrag_${formData.Name}_${formData.Vorname}.pdf`;
      doc.save(fileName);
    }
  </script>
</body>
</html>
