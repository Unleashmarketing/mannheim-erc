<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Antrag Eislaufschule - Mannheimer ERC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      /* ========================================
       CSS VARIABLES
       ======================================== */
      :root {
        --primary-color: #0062ff;
        --primary-hover: #0052d9;
        --secondary-color: #e4e3d3;
        --dark-bg: #111111;
        --light-bg: #f7f7f2;
        --accent-color: #ff3a29; /* Fehlerfarbe */
        --text-dark: #222222;
        --text-light: #f7f7f7;
        --text-muted: #555555;
        --gray-light: #e0e0e0;
        --gray-medium: #999999;
        --white: #ffffff;

        --spacing-xs: 8px;
        --spacing-sm: 16px;
        --spacing-md: 24px;
        --spacing-lg: 40px;
        --spacing-xl: 60px;
        --spacing-2xl: 80px;

        --font-family:
          "Outfit", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --font-family-accent: "Space Grotesk", monospace;

        --border-radius-md: 8px;
        --border-radius-lg: 12px;
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
        --transition-base: 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
      }

      /* ========================================
       RESET & BASE STYLES
       ======================================== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        scroll-behavior: smooth;
        font-size: 16px;
      }
      body {
        font-family: var(--font-family);
        background-color: var(--light-bg);
        color: var(--text-dark);
        line-height: 1.6;
        padding: var(--spacing-lg) 0;
      }

      /* ========================================
       FORM STYLES
       ======================================== */
      .form-container {
        max-width: 900px;
        margin: 0 auto var(--spacing-2xl);
        background: var(--white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
      }

      .form-header {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          #0047b3 100%
        );
        color: var(--white);
        padding: var(--spacing-2xl) var(--spacing-lg);
        text-align: center;
        position: relative;
      }

      .back-button-top {
        position: absolute;
        top: var(--spacing-md);
        left: var(--spacing-md);
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: 12px 20px;
        background: rgba(255, 255, 255, 0.15);
        color: var(--white);
        text-decoration: none;
        border-radius: var(--border-radius-md);
        font-weight: 600;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .form-header h1 {
        font-family: var(--font-family-accent);
        font-size: 2.5rem;
        font-weight: 900;
        margin-bottom: var(--spacing-sm);
      }

      .form-body {
        padding: var(--spacing-2xl) var(--spacing-lg);
        display: none;
        transition: opacity var(--transition-base);
      }

      .form-body.visible {
        display: block;
        opacity: 1;
        animation: fadeIn 0.4s ease-out;
      }

      .form-section {
        margin-bottom: var(--spacing-2xl);
      }
      .form-section h2 {
        font-family: var(--font-family-accent);
        font-size: 1.5rem;
        color: var(--primary-color);
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-sm);
        border-bottom: 3px solid var(--gray-light);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
      }

      .form-group {
        display: flex;
        flex-direction: column;
        position: relative;
      }
      .form-group.full-width {
        grid-column: 1 / -1;
      }

      label {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        font-size: 0.9rem;
      }
      label .required {
        color: var(--accent-color);
      }

      input,
      select {
        padding: 14px 16px;
        border: 2px solid var(--gray-light);
        border-radius: var(--border-radius-md);
        font-size: 1rem;
        transition: var(--transition-base);
        font-family: inherit;
        background-color: var(--white);
        width: 100%;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      /* --- FEHLER STYLES (NEU) --- */
      input.input-error,
      select.input-error {
        border-color: var(--accent-color) !important;
        background-color: #fff5f5;
      }

      .error-message {
        color: var(--accent-color);
        font-size: 0.85rem;
        margin-top: 6px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px;
        animation: fadeIn 0.3s ease;
      }

      .error-message::before {
        content: "⚠️"; /* Oder FontAwesome Icon */
        font-size: 0.8rem;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* -------------------------- */

      .checkbox-group {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        background-color: var(--light-bg);
        border-radius: var(--border-radius-md);
      }
      .checkbox-group input {
        width: 20px;
        height: 20px;
        margin-top: 2px;
      }

      .btn-container {
        display: flex;
        gap: var(--spacing-md);
        justify-content: flex-end;
        margin-top: var(--spacing-2xl);
        padding-top: var(--spacing-lg);
        border-top: 2px solid var(--gray-light);
      }

      button,
      .btn-secondary {
        padding: 16px 32px;
        border-radius: var(--border-radius-md);
        font-weight: 600;
        cursor: pointer;
        font-family: var(--font-family-accent);
        border: none;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background-color: var(--primary-color);
        color: var(--white);
      }
      .btn-primary:disabled {
        background-color: var(--gray-medium);
        cursor: not-allowed;
      }
      .btn-secondary {
        background-color: transparent;
        border: 2px solid var(--gray-light);
        color: var(--text-dark);
      }

      /* Alert Box oben */
      .alert-box {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }
      .alert-box.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #f87171;
      }
      .alert-box.success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #4ade80;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }
        .form-body {
          padding: var(--spacing-md);
        }
        .btn-container {
          flex-direction: column-reverse;
        }
        button,
        .btn-secondary {
          width: 100%;
          text-align: center;
        }
      }

      /* Antraege section */
      .antrag-section {
        padding: var(--spacing-3xl) 0;
        background-color: var(--light-bg);
      }
      #antrag-eislaufschule-toggle-btn {
        font-size: var(--font-size-3xl);
        font-weight: 800;
        color: var(--text-dark);
        font-family: var(--font-family-accent);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        transition: var(--transition-base);
        position: relative;
      }

      #antrag-eislaufschule-toggle-btn:hover {
        color: var(--primary-color);
      }

      #antrag-eislaufschule-toggle-btn::after {
        content: "";
        display: block;
        width: 60px;
        height: 4px;
        background-color: var(--primary-color);
        margin: var(--spacing-md) auto 0;
        border-radius: var(--border-radius-sm);
        position: absolute;
        bottom: -16px;
        left: 50%;
        transform: translateX(-50%);
      }

      #antrag-eislaufschule-toggle-icon {
        display: inline-block;
        transition: transform 0.3s ease;
        font-size: var(--font-size-lg);
        color: var(--dark-bg);
      }

      #antrag-eislaufschule-toggle-btn.active
        #antrag-eislaufschule-toggle-icon {
        transform: rotate(-180deg);
      }

      #antrag-eislaufschule-toggle-btn.clicked
        #antrag-eislaufschule-toggle-icon {
        transform: rotate(-90deg);
      }

      #aufnahmeantrag-toggle-btn {
        font-size: var(--font-size-3xl);
        font-weight: 800;
        color: var(--text-dark);
        font-family: var(--font-family-accent);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        transition: var(--transition-base);
        position: relative;
      }

      #aufnahmeantrag-toggle-btn:hover {
        color: var(--primary-color);
      }

      #aufnahmeantrag-toggle-btn::after {
        content: "";
        display: block;
        width: 60px;
        height: 4px;
        background-color: var(--primary-color);
        margin: var(--spacing-md) auto 0;
        border-radius: var(--border-radius-sm);
        position: absolute;
        bottom: -16px;
        left: 50%;
        transform: translateX(-50%);
      }

      #aufnahmeantrag-toggle-icon {
        display: inline-block;
        transition: transform 0.3s ease;
        font-size: var(--font-size-lg);
        color: var(--dark-bg);
      }

      #aufnahmeantrag-toggle-btn.active #aufnahmeantragtoggle-icon {
        transform: rotate(-180deg);
      }

      #aufnahmeantrag-toggle-btn.clicked #aufnahmeantrag-toggle-icon {
        transform: rotate(-90deg);
      }
    </style>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Space+Grotesk:wght@700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <section class="antrag-section">
      <!-- Eislaufschule -->
      <div class="form-container">
        <div class="form-header">
          <a href="about.html" class="back-button-top">Zurück</a>
          <div
            class="tan-group"
            style="display: flex; gap: 10px; margin-bottom: 10px"
          >
            <input
              id="antrag-eislaufschule-TAN"
              type="text"
              placeholder="Bitte TAN eingeben"
              required
              style="display: block; background-color: burlywood"
            />
            <input
              id="antrag-eislaufschule-existing-TAN-email"
              type="email"
              placeholder="e-Mail zur Authentifizierung"
              value=""
              style="display: none"
            /><button type="button" id="verify-eislaufschule-tan-btn">
              Prüfen
            </button>
          </div>
          <h1 id="antrag-eislaufschule-toggle-btn">
            Antrag Eislaufschule<span id="antrag-eislaufschule-toggle-icon"
              >▼</span
            >
          </h1>
          <p id="antrag-eislaufschule-newstart-warning" style="display: none">
            Erneutes clicken löscht alle Eingaben
          </p>
          <p>Bitte füllen Sie alle erforderlichen Felder aus</p>
        </div>

        <div id="antrag-eislaufschule-wrapper" class="form-body">
          <div
            id="generalAlertEislaufSchule"
            class="alert-box-eislaufschule"
          ></div>

          <form id="antragFormEislaufschule" novalidate>
            <div class="form-section">
              <h2>Persönliche Daten</h2>
              <div class="form-row">
                <div class="form-group">
                  <label>Name Erziehungsberechtigte</label>
                  <input type="text" name="NameErziehungsberechtigte" />
                </div>
                <div class="form-group">
                  <label>Vorname Erziehungsberechtigte</label>
                  <input type="text" name="VornameErziehungsberechtigte" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group full-width" style="margin-bottom: 24px">
                  <label>Geburtsdatum Erziehungsberechtigte</label>
                  <input type="date" name="GeburtsdatumErziehungsberechtigte" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label
                    >Name Teilnehmer 1 <span class="required">*</span></label
                  >
                  <input type="text" name="NameTeilnehmer1" required />
                </div>
                <div class="form-group">
                  <label
                    >Vorname Teilnehmer 1 <span class="required">*</span></label
                  >
                  <input type="text" name="VornameTeilnehmer1" required />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group full-width" style="margin-bottom: 24px">
                  <label
                    >Geburtsdatum Teilnehmer 1
                    <span class="required">*</span></label
                  >
                  <input type="date" name="GeburtsdatumTeilnehmer1" required />
                </div>
              </div>

              <div class="form-group full-width" style="margin-bottom: 24px">
                <label
                  >Straße und Hausnummer <span class="required">*</span></label
                >
                <input type="text" name="Strasse" required />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Postleitzahl <span class="required">*</span></label>
                  <input
                    type="text"
                    name="PLZ"
                    placeholder="z.B. 68159"
                    required
                  />
                </div>
                <div class="form-group">
                  <label>Wohnort <span class="required">*</span></label>
                  <input type="text" name="Wohnort" required />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Name Zusatzteilnehmer 1</label>
                  <input type="text" name="NameZusatzteilnehmer1" />
                </div>
                <div class="form-group">
                  <label>Vorname Zusatzteilnehmer 1</label>
                  <input type="text" name="VornameZusatzteilnehmer1" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group full-width" style="margin-bottom: 24px">
                  <label>Geburtsdatum Zusatzteilnehmer 1</label>
                  <input type="date" name="GeburtsdatumZusatzteilnehmer1" />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Name Zusatzteilnehmer 2</label>
                  <input type="text" name="NameZusatzteilnehmer2" />
                </div>
                <div class="form-group">
                  <label>Vorname Zusatzteilnehmer 2</label>
                  <input type="text" name="VornameZusatzteilnehmer2" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group full-width" style="margin-bottom: 24px">
                  <label>Geburtsdatum Zusatzteilnehmer 2</label>
                  <input type="date" name="GeburtsdatumZusatzteilnehmer2" />
                </div>
              </div>
            </div>

            <div class="form-section">
              <h2>Kontaktdaten</h2>
              <div class="form-row">
                <div class="form-group">
                  <label>Telefon/Mobil <span class="required">*</span></label>
                  <input
                    type="tel"
                    name="TelefonMobil"
                    placeholder="+49 123 456789"
                    required
                  />
                </div>
                <div class="form-group">
                  <label>E-Mail <span class="required">*</span></label>
                  <input
                    id="antrag-eislaufschule-email-input"
                    type="email"
                    name="eMail"
                    required
                  />
                </div>
              </div>
            </div>

            <div class="form-section">
              <h2>Bankverbindung</h2>
              <div class="form-group" style="margin-bottom: 24px">
                <label
                  >Name des Kreditinstituts
                  <span class="required">*</span></label
                >
                <input type="text" name="NameKreditinstitut" required />
              </div>

              <div class="form-group" style="margin-bottom: 24px">
                <label>Kontoinhaber <span class="required">*</span></label>
                <input type="text" name="Kontoinhaber" required />
              </div>

              <div class="form-group" style="margin-bottom: 24px">
                <label>IBAN <span class="required">*</span></label>
                <input
                  type="text"
                  name="IBAN"
                  placeholder="DE00 0000 0000 0000 0000 00"
                  required
                />
              </div>

              <div class="form-group full-width">
                <div class="checkbox-group">
                  <input
                    type="checkbox"
                    id="einzug-eislaufschule"
                    name="Einzugsermaechtigung"
                    required
                  />
                  <label for="einzug-eislaufschule">
                    Ich erteile die Einzugsermächtigung für den Beitragseinzug
                    <span class="required">*</span>
                  </label>
                </div>
                <div id="checkbox-error-container-eislaufschule"></div>
              </div>
            </div>

            <div class="btn-container">
              <a href="about.html" class="btn-secondary">Zurück</a>
              <button
                type="submit"
                class="btn-primary"
                id="submitBtnEislaufschule"
              >
                <span id="btnTextEislaufschule"
                  >Antrag absenden & PDF laden</span
                >
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Aufnahmeantrag -->
      <div class="form-container">
        <div class="form-header">
          <a href="about.html" class="back-button-top">Zurück</a>
          <div
            class="tan-group"
            style="display: flex; gap: 10px; margin-bottom: 10px"
          >
            <input
              id="aufnahmeantrag-TAN"
              type="text"
              placeholder="Bitte TAN eingeben"
              required
              style="display: block; background-color: burlywood"
            />
            <input
              id="aufnahmeantrag-existing-TAN-email"
              type="email"
              placeholder="e-Mail zur Authentifizierung"
              value=""
              style="display: none"
            />
            <button type="button" id="verify-aufnahmeantrag-tan-btn">
              Prüfen
            </button>
          </div>
          <h1 id="aufnahmeantrag-toggle-btn">
            Aufnahmeantrag<span id="aufnahmeantrag-toggle-icon">▼</span>
          </h1>
          <p id="aufnahmeantrag-newstart-warning" style="display: none">
            Erneutes clicken löscht alle Eingaben
          </p>
          <p>Bitte füllen Sie alle erforderlichen Felder aus</p>
        </div>

        <div id="aufnahmeantrag-wrapper" class="form-body">
          <div
            id="generalAlertAufnahmeAntrag"
            class="alert-box-aufnahmeantrag"
          ></div>
          <form id="antragFormAufnahmeantrag" novalidate>
            <div class="form-section">
              <h2>Persönliche Daten</h2>
              <div class="form-row">
                <div class="form-group">
                  <label>Nachname <span class="required">*</span></label>
                  <input type="text" name="Name" required />
                </div>
                <div class="form-group">
                  <label>Vorname <span class="required">*</span></label>
                  <input type="text" name="Vorname" required />
                </div>
              </div>

              <div class="form-group full-width" style="margin-bottom: 24px">
                <label
                  >Straße und Hausnummer <span class="required">*</span></label
                >
                <input type="text" name="Strasse" required />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Postleitzahl <span class="required">*</span></label>
                  <input
                    type="text"
                    name="PLZ"
                    placeholder="z.B. 68159"
                    required
                  />
                </div>
                <div class="form-group">
                  <label>Wohnort <span class="required">*</span></label>
                  <input type="text" name="Wohnort" required />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group full-width" style="margin-bottom: 24px">
                  <label>Geburtsdatum <span class="required">*</span></label>
                  <input type="date" name="Geburtsdatum" required />
                </div>
                <div class="form-group">
                  <label>Geschlecht <span class="required">*</span></label>
                  <select name="Geschlecht" required>
                    <option value="">Bitte wählen</option>
                    <option value="M">Männlich</option>
                    <option value="W">Weiblich</option>
                    <option value="D">Divers</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label
                  >Staatsangehörigkeit <span class="required">*</span></label
                >
                <input
                  type="text"
                  name="Staatsangehoerigkeit"
                  value="Deutsch"
                  required
                />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Name Minderjährige</label>
                  <input type="text" name="NameMinderjaehrige" />
                </div>
                <div class="form-group">
                  <label>Vorname Minderjährige</label>
                  <input type="text" name="VornameMinderjaehrige" />
                </div>
              </div>
              <div class="form-group full-width" style="margin-bottom: 24px">
                <label>Straße und Hausnummer Minderjährige </label>
                <input type="text" name="StrasseMinderjaehrige" />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Postleitzahl Minderjährige</label>
                  <input
                    type="text"
                    name="PLZMinderjaehrige"
                    placeholder="z.B. 68159"
                  />
                </div>
                <div class="form-group">
                  <label>Wohnort Minderjährige</label>
                  <input type="text" name="WohnortMinderjaehrige" />
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group full-width" style="margin-bottom: 24px">
                <label>Geburtsdatum Minderjährige</label>
                <input type="date" name="GeburtsdatumMinderjaehrige" />
              </div>
              <div class="form-group">
                <label>Geschlecht Minderjährige</label>
                <select name="GeschlechtMinderjaehrige">
                  <option value="">Bitte wählen</option>
                  <option value="M">Männlich</option>
                  <option value="W">Weiblich</option>
                  <option value="D">Divers</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Staatsangehörigkeit Minderjährige</label>
              <input
                type="text"
                name="StaatsangehoerigkeitMinderjaehrige"
                value="Deutsch"
              />
            </div>

            <div class="form-section">
              <h2>Kontaktdaten</h2>
              <div class="form-row">
                <div class="form-group">
                  <label>Telefon/Mobil <span class="required">*</span></label>
                  <input
                    type="tel"
                    name="TelefonMobil"
                    placeholder="+49 123 456789"
                    required
                  />
                </div>
                <div class="form-group">
                  <label>E-Mail <span class="required">*</span></label>
                  <input
                    id="aufnahmeantrag-email-input"
                    type="email"
                    name="eMail"
                    required
                  />
                </div>
              </div>
            </div>

            <div class="form-section">
              <h2>Abteilung</h2>
              <div class="form-row">
                <div class="form-group">
                  <label>Abteilung <span class="required">*</span></label>
                  <select name="Abteilung" id="abteilung" required>
                    <option value="">Bitte wählen</option>
                    <option value="Kunstlauf">Eiskunstlauf</option>
                    <option value="Schnelllauf">
                      Eisschnelllauf / Shorttrack
                    </option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Unterabteilung</label>
                  <select name="Unterabteilung" id="unterabteilung">
                    <option value="">Bitte wählen</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="form-section">
              <h2>Bankverbindung</h2>
              <div class="form-group" style="margin-bottom: 24px">
                <label
                  >Name des Kreditinstituts
                  <span class="required">*</span></label
                >
                <input type="text" name="NameKreditinstitut" required />
              </div>

              <div class="form-group" style="margin-bottom: 24px">
                <label>Kontoinhaber <span class="required">*</span></label>
                <input type="text" name="Kontoinhaber" required />
              </div>

              <div class="form-group" style="margin-bottom: 24px">
                <label>IBAN <span class="required">*</span></label>
                <input
                  type="text"
                  name="IBAN"
                  placeholder="DE00 0000 0000 0000 0000 00"
                  required
                />
              </div>

              <div class="form-group full-width">
                <div class="checkbox-group">
                  <input
                    type="checkbox"
                    id="einzug-aufnahmeantrag"
                    name="Einzugsermaechtigung"
                    required
                  />
                  <label for="einzug-aufnahmeantrag">
                    Ich erteile die Einzugsermächtigung für den Beitragseinzug
                    <span class="required">*</span>
                  </label>
                </div>
                <div id="checkbox-error-container-aufnahmeantrag"></div>
              </div>
            </div>

            <div class="btn-container">
              <a href="about.html" class="btn-secondary">Zurück</a>
              <button
                type="submit"
                class="btn-primary"
                id="submitBtnAufnahmeantrag"
              >
                <span id="btnTextAufnahmeantrag"
                  >Antrag absenden & PDF laden</span
                >
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <script>
      const { jsPDF } = globalThis.jspdf;

      // --- DYNAMISCHE UNTERABTEILUNGEN ---
      const abteilungSelect = document.getElementById("abteilung");
      const unterabteilungSelect = document.getElementById("unterabteilung");

      const unterabteilungen = {
        Kunstlauf: [
          { value: "Einzel", label: "Einzel" },
          { value: "Paarlauf", label: "Paarlauf" },
          { value: "Formation", label: "Formation / Synchron" },
          { value: "Erwachsene", label: "Erwachsene" },
        ],
        Schnelllauf: [{ value: "Shorttrack", label: "Shorttrack" }],
      };

      abteilungSelect.addEventListener("change", function () {
        unterabteilungSelect.innerHTML =
          '<option value="">Bitte wählen</option>';
        if (this.value && unterabteilungen[this.value]) {
          unterabteilungen[this.value].forEach((option) => {
            const opt = document.createElement("option");
            opt.value = option.value;
            opt.textContent = option.label;
            unterabteilungSelect.appendChild(opt);
          });
        }
      });

      // --- VALIDIERUNGS-HELFER ---

      // Zeigt Fehler unter einem Input Feld an
      function showFieldError(inputElement, message) {
        inputElement.classList.add("input-error");

        // Prüfen ob schon eine Nachricht da ist
        let errorDiv =
          inputElement.parentElement.querySelector(".error-message");
        if (!errorDiv) {
          errorDiv = document.createElement("div");
          errorDiv.className = "error-message";
          inputElement.parentElement.appendChild(errorDiv);
        }
        errorDiv.textContent = message;
      }

      // Entfernt alle Fehleranzeigen
      function clearValidationErrors(generalAlertId) {
        document
          .querySelectorAll(".input-error")
          .forEach((el) => el.classList.remove("input-error"));
        document
          .querySelectorAll(".error-message")
          .forEach((el) => el.remove());
        const alertBox = document.getElementById(generalAlertId);
        alertBox.style.display = "none";
        alertBox.className = "alert-box";
      }

      // IBAN Algorithmus
      function isValidIBAN(iban) {
        const cleanIban = String(iban)
          .toUpperCase()
          .replace(/[^A-Z0-9]/g, "");
        if (cleanIban.length < 15) return 1; // Simple Length Check vorab

        const code = cleanIban.match(/^([A-Z]{2})(\d{2})([A-Z\d]+)$/);
        if (!code) return 2;

        const digits = (code[3] + code[1] + code[2]).replace(
          /[A-Z]/g,
          function (letter) {
            return letter.charCodeAt(0) - 55;
          },
        );
        let checksum = digits.slice(0, 2);
        for (let offset = 2; offset < digits.length; offset += 7) {
          const fragment =
            String(checksum) + digits.substring(offset, offset + 7);
          checksum = Number.parseInt(fragment, 10) % 97;
        }
        return checksum === 1 ? 0 : checksum;
      }

      // Email Regex
      function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      // --- FORM SUBMIT HANDLER ---
      function handleFormSubmit(
        formId,
        submitBtnId,
        btnTextId,
        checkBoxErrorId,
        generalAlertId,
        integerDocType,
        tanFieldId,
      ) {
        document
          .getElementById(formId)
          .addEventListener("submit", async function (e) {
            e.preventDefault(); // Verhindert das Standard-Neuladen
            clearValidationErrors(generalAlertId); // Alte Fehler löschen

            const submitBtn = document.getElementById(submitBtnId);
            const btnText = document.getElementById(btnTextId);
            const tanField = document.getElementById(tanFieldId);
            let hasErrors = false;
            let firstErrorField = null;

            const data = {};

            // 1. SCHRITT: PFLICHTFELDER & FORMATE PRÜFEN

            // Wir iterieren über die Form-Elemente, um direkten Zugriff auf das DOM für Fehlermeldungen zu haben
            const elements = this.elements;

            for (const field of elements) {
              // Ignoriere Buttons und Fieldsets
              if (field.type === "submit" || field.tagName === "BUTTON")
                continue;

              const value = field.value.trim();
              const name = field.name;

              // Daten für später speichern
              if (field.type === "checkbox") {
                if (field.checked) data[name] = "ja";
              } else {
                data[name] = value;
              }

              // A) Prüfung auf leere Pflichtfelder
              if (field.hasAttribute("required")) {
                if (field.type === "checkbox" && !field.checked) {
                  // Spezialfall Checkbox (hat kein direktes parent, sondern checkbox-group)
                  const container = document.getElementById(checkBoxErrorId);
                  const msg = document.createElement("div");
                  msg.className = "error-message";
                  msg.textContent =
                    "Bitte stimmen Sie der Einzugsermächtigung zu.";
                  container.appendChild(msg);
                  hasErrors = true;
                  if (!firstErrorField) firstErrorField = field;
                } else if (field.type !== "checkbox" && value === "") {
                  showFieldError(field, "Dieses Feld ist erforderlich.");
                  hasErrors = true;
                  if (!firstErrorField) firstErrorField = field;
                }
              }

              // B) Spezifische Format-Prüfungen (nur wenn Wert vorhanden)

              if (value !== "") {
                // if (name === 'PLZ' && !/^\d{5}$/.test(value)) {
                //     showFieldError(field, 'Bitte eine 5-stellige PLZ eingeben.');
                //     hasErrors = true;
                // } Keine PLZ Wertueberpruefung falls die im Ausland Wohnen
                if (name === "e-Mail" && !isValidEmail(value)) {
                  showFieldError(field, "Ungültige E-Mail-Adresse.");
                  hasErrors = true;
                }
                const ibanCheckVal = isValidIBAN(value);
                if (name === "IBAN" && ibanCheckVal !== 0) {
                  showFieldError(
                    field,
                    "Ungültige IBAN: " + ibanCheckVal.toString(),
                  );
                  hasErrors = true;
                }
              }
            }

            // Falls Fehler gefunden wurden: Abbruch & Scrollen
            if (hasErrors) {
              if (firstErrorField) {
                firstErrorField.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
                firstErrorField.focus();
              }
              return; // STOPP HIER
            }

            // 2. SCHRITT: ALLES OK -> SENDEN & PDF
            submitBtn.disabled = true;
            btnText.textContent = "Wird verarbeitet...";

            try {
              // A) Senden an Server (E-Mail Versand Backend)
              // WICHTIG: Ersetze '/api/submit-antrag' mit deiner echten URL!

              // Simulierter Erfolg (nimm das raus, wenn dein Server live ist)
              await new Promise((r) => setTimeout(r, 1000));

              // B) PDF Client-Side Generierung (als Backup/Sofort-Download)
              generatePDF(data, integerDocType, tanField.value);

              // Erfolgsmeldung anzeigen
              const alertBox = document.getElementById(generalAlertId);
              alertBox.style.display = "block";
              alertBox.className = "alert-box success";
              alertBox.textContent =
                "Antrag erfolgreich übermittelt! PDF wird heruntergeladen.";
              alertBox.scrollIntoView({ behavior: "smooth" });

              setTimeout(() => {
                this.reset();
                submitBtn.disabled = false;
                btnText.textContent = "Antrag absenden & PDF laden";
                clearValidationErrors(generalAlertId);
              }, 3000);
            } catch (error) {
              console.error(error);
              const alertBox = document.getElementById(generalAlertId);
              alertBox.style.display = "block";
              alertBox.className = "alert-box error";
              alertBox.textContent =
                "Fehler beim Senden. Bitte prüfen Sie Ihre Verbindung.";
              submitBtn.disabled = false;
              btnText.textContent = "Erneut versuchen";
            }
          });
      }

      // --- PDF GENERATOR (UNVERÄNDERT) ---
      async function generatePDF(formData, integerDocType, tan) {
        const doc = new jsPDF();
        doc.setFontSize(18);
        doc.setFont(undefined, "bold");
        switch (integerDocType) {
          case 0:
            doc.text("Antrag Eislaufschule", 20, 20);
            break;
          case 1:
            doc.text("Aufnahmeantrag", 20, 20);
            break;
          default:
            doc.text("Antrag", 20, 20);
        }
        doc.setFontSize(11);
        doc.setFont(undefined, "normal");

        let yPos = 35;
        const lh = 8;
        const lm = 20;

        const printLine = (label, val, isBoldTitle = false) => {
          if (isBoldTitle) {
            doc.setFont(undefined, "bold");
            doc.text(label, lm, yPos);
            doc.setFont(undefined, "normal");
          } else {
            doc.text(`${label} ${val}`, lm + 5, yPos);
          }
          yPos += lh;
        };

        let formFilled = false;
        switch (integerDocType) {
          case 0: //EISLAUFSCHULE
            printLine("Persönliche Daten:", "", true);
            printLine("Name:", formData.NameTeilnehmer1);
            printLine("Vorname:", formData.VornameTeilnehmer1);
            printLine("Straße:", formData.Strasse);
            printLine("PLZ:", formData.PLZ);
            printLine("Wohnort:", formData.Wohnort);
            printLine("Geburtsdatum:", formData.GeburtsdatumTeilnehmer1);
            yPos += 5;

            printLine("Kontaktdaten:", "", true);
            printLine("Tel:", formData.TelefonMobil);
            printLine("Email:", formData.eMail);
            yPos += 5;

            if (formData.NameErziehungsberechtigte !== "") {
              printLine(
                "Name Erziehungsberechtigte",
                formData.NameErziehungsberechtigte,
              );
            }
            if (formData.VornameErziehungsberechtigte !== "") {
              printLine(
                "Vorname Erziehungsberechtigte",
                formData.VornameErziehungsberechtigte,
              );
            }
            if (formData.GeburtsdatumErziehungsberechtigte !== "") {
              printLine(
                "Geburtsdatum Erziehungsberechtigte",
                formData.GeburtsdatumErziehungsberechtigte,
              );
            }
            if (formData.NameZusatzteilnehmer1 !== "") {
              printLine(
                "Name Zusatzteilnehmer 1",
                formData.NameZusatzteilnehmer1,
              );
            }
            if (formData.VornameZusatzteilnehmer1 !== "") {
              printLine(
                "Vorname Zusatzteilnehmer 1",
                formData.VornameZusatzteilnehmer1,
              );
            }
            if (formData.GeburtsdatumZusatzteilnehmer1 !== "") {
              printLine(
                "Geburtsdatum Zusatzteilnehmer 1",
                formData.GeburtsdatumZusatzteilnehmer1,
              );
            }
            if (formData.NameZusatzteilnehmer2 !== "") {
              printLine(
                "Name Zusatzteilnehmer 2",
                formData.NameZusatzteilnehmer2,
              );
            }
            if (formData.VornameZusatzteilnehmer2 !== "") {
              printLine(
                "Vorname Zusatzteilnehmer 2",
                formData.VornameZusatzteilnehmer2,
              );
            }
            if (formData.GeburtsdatumZusatzteilnehmer2 !== "") {
              printLine(
                "Geburtsdatum Zusatzteilnehmer 2",
                formData.GeburtsdatumZusatzteilnehmer2,
              );
            }
            yPos += 5;
            formFilled = true;
            break;

          case 1: //AUFNAHMEANTRAG
            printLine("Persönliche Daten:", "", true);
            printLine("Name:", formData.Name);
            printLine("Vorname:", formData.Vorname);
            printLine("Straße:", formData.Strasse);
            printLine("PLZ:", formData.PLZ);
            printLine("Wohnort:", formData.Wohnort);
            printLine("Geburtsdatum:", formData.Geburtsdatum);
            printLine("Geschlecht:", formData.Geschlecht);
            printLine("Staatsangehörigkeit:", formData.Staatsangehoerigkeit);
            if (formData.NameMinderjaehrige !== "") {
              printLine("Name Minderjährige:", formData.NameMinderjaehrige);
            }
            if (formData.VornameMinderjaehrige !== "") {
              printLine(
                "Vorname Minderjährige:",
                formData.VornameMinderjaehrige,
              );
            }
            if (formData.StrasseMinderjaehrige !== "") {
              printLine(
                "Straße Minderjährige:",
                formData.StrasseMinderjaehrige,
              );
            }
            if (formData.PLZMinderjaehrige !== "") {
              printLine("PLZ Minderjährige:", formData.PLZMinderjaehrige);
            }
            if (formData.WohnortMinderjaehrige !== "") {
              printLine(
                "Wohnort Minderjährige:",
                formData.WohnortMinderjaehrige,
              );
            }
            if (formData.GeburtsdatumMinderjaehrige != "") {
              printLine(
                "Geburtsdatum Minderjährige:",
                formData.GeburtsdatumMinderjaehrige,
              );
            }
            if (formData.GeschlechtMinderjaehrige !== "") {
              printLine(
                "Geschlecht Minderjährige:",
                formData.GeschlechtMinderjaehrige,
              );
            }
            if (formData.StaatsangehoerigkeitMinderjaehrige != "") {
              printLine(
                "Staatsangehörigkeit Minderjährige:",
                formData.StaatsangehoerigkeitMinderjaehrige,
              );
            }
            yPos += 5;

            printLine("Kontaktdaten:", "", true);
            printLine("Tel:", formData.TelefonMobil);
            printLine("Email:", formData.eMail);
            yPos += 5;

            printLine("Abteilung:", "", true);
            printLine("Bereich:", formData.Abteilung);
            if (formData.Unterabteilung)
              printLine("Unterabteilung:", formData.Unterabteilung);
            yPos += 5;
            formFilled = true;
            break;

          default:
            printLine(
              "Falsche docType gewählt: " + integerDocType.toString(),
              "",
              true,
            );
            break;
        }
        if (formFilled) {
          printLine("Bankverbindung:", "", true);
          printLine("Bank:", formData.NameKreditinstitut);
          printLine("IBAN:", formData.IBAN);
          printLine("Inhaber:", formData.Kontoinhaber);
          printLine("Einzug:", "Ja, erteilt");
        }

        const fileName = `Antrag_${tan}.pdf`;
        let fData = new FormData();
        fData.append("subject", "Neues Formular von der Webseite");
        fData.append("message", "Siehe Anhang");
        // fData.append("email", formData.eMail); <- may be used to CC the applicant
        fData.append("attachment", doc.output("blob", { filename: fileName }));
        fData.append("attachmentName", fileName);
        const response = await fetch("https://merc-online.de/cgi-bin/apiMain.py/api/submit", {
          method: "POST",
          body: fData,
        });
        if (response.ok) {
          let fData2 = new FormData();
          fData2.append("tan", tan);
          fData2.append("email", formData.eMail);
          fData2.append("formEnum", integerDocType.toString());
          const response2 = await fetch(
            "https://merc-online.de/cgi-bin/apiMain.py/api/assignEmailToTan",
            {
              method: "POST",
              body: fData2,
            },
          );
          const result = await response2.json();
          if (result["success"]) {
            doc.save(fileName);
          }
        }
      }

      const tanUngueltigMsg = "Ungültige TAN";
      const tanFalscheFormMsg = "TAN für diesen Formulartyp nicht verwendbar";

      function toggleAntragVisibility(
        antragBtn,
        elementId,
        tanID,
        tanIdButton,
        existingEmailForTanId = "",
        emailInputId = "",
        newStartWarningId = "",
        antragTyp = "0", // EISLAUFSCHULE: "0", AUFNAHMEANTRAG: "1"
      ) {
        const toggleButton = document.getElementById(antragBtn);
        const wrapper = document.getElementById(elementId);
        const tanField = document.getElementById(tanID);
        const tanButton = document.getElementById(tanIdButton);
        let existingEmailForTan = null;
        if (existingEmailForTanId !== "") {
          existingEmailForTan = document.getElementById(existingEmailForTanId);
        }
        let emailInput = null;
        if (emailInputId != "") {
          emailInput = document.getElementById(emailInputId);
        }
        let newStartWarning = null;
        if (newStartWarningId != "") {
          newStartWarning = document.getElementById(newStartWarningId);
        }
        if (!toggleButton || !wrapper || !tanField || !tanButton) return;
        let boolTanValid = false;

        tanButton.addEventListener("click", async function () {
          const tanValue = tanField.value;
          if (
            !tanValue ||
            tanValue === tanUngueltigMsg ||
            tanValue === tanFalscheFormMsg
          ) {
            return;
          }
          let params = "?tan=" + encodeURIComponent(tanValue);
          params += "&formEnum=" + encodeURIComponent(antragTyp);
          if (existingEmailForTan && existingEmailForTan.value !== "") {
            params += "&email=" + encodeURIComponent(existingEmailForTan.value);
          }
          const response = await fetch(
            "https://merc-online.de/cgi-bin/apiMain.py/api/isTanValid" + params
          );
          const result = await response.text();
          if (!response.ok || (response.ok && result !== "5")) {
            existingEmailForTan.style.display = "none";
          }
          if (response.ok && (result === "1" || result === "2")) {
            boolTanValid = true;
            tanField.readOnly = true;
            tanField.style.backgroundColor = "#96C487";
            tanField.style.cursor = "not-allowed";
            if (result === "2") {
              emailInput.value = existingEmailForTan.value;
              existingEmailForTan.value = "";
              emailInput.readOnly = true;
              emailInput.style.cursor = "not-allowed";
            }
          } else if (response.ok && result === "5" && existingEmailForTan) {
            existingEmailForTan.style.display = "block";
          } else if (response.ok && result === "6") {
            tanField.value = tanFalscheFormMsg;
          } else {
            tanField.value = tanUngueltigMsg;
          }
        });

        toggleButton.addEventListener("click", async function () {
          await new Promise((resolve) => setTimeout(resolve, 50));
          newStartWarning.style.display = "none";
          toggleButton.classList.add("clicked");
          if (!boolTanValid) {
            tanField.focus();
            setTimeout(() => {
              toggleButton.classList.remove("clicked");
            }, 500);
            return;
          }
          const isCurrentlyOpen = wrapper.classList.contains("visible");
          if (!isCurrentlyOpen) {
            toggleButton.classList.remove("clicked");
            toggleButton.classList.add("active");
            void wrapper.offsetWidth;
            wrapper.classList.add("visible");
            newStartWarning.style.display = "block";
          } else {
            setTimeout(() => {
              wrapper.classList.remove("visible");
              toggleButton.classList.remove("clicked", "active");
              tanField.readOnly = false;
              tanField.style.backgroundColor = "burlywood";
              tanField.style.cursor = "";
              tanField.value = "";
              existingEmailForTan.value = "";
              boolTanValid = false;
            }, 500);
          }
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        toggleAntragVisibility(
          "antrag-eislaufschule-toggle-btn",
          "antrag-eislaufschule-wrapper",
          "antrag-eislaufschule-TAN",
          "verify-eislaufschule-tan-btn",
          "antrag-eislaufschule-existing-TAN-email",
          "antrag-eislaufschule-email-input",
          "antrag-eislaufschule-newstart-warning",
          "0",
        );
        toggleAntragVisibility(
          "aufnahmeantrag-toggle-btn",
          "aufnahmeantrag-wrapper",
          "aufnahmeantrag-TAN",
          "verify-aufnahmeantrag-tan-btn",
          "aufnahmeantrag-existing-TAN-email",
          "aufnahmeantrag-email-input",
          "aufnahmeantrag-newstart-warning",
          "1",
        );
        handleFormSubmit(
          "antragFormEislaufschule",
          "submitBtnEislaufschule",
          "btnTextEislaufschule",
          "checkbox-error-container-eislaufschule",
          "generalAlertEislaufSchule",
          0,
          "antrag-eislaufschule-TAN",
        );
        handleFormSubmit(
          "antragFormAufnahmeantrag",
          "submitBtnAufnahmeantrag",
          "btnTextAufnahmeantrag",
          "checkbox-error-container-aufnahmeantrag",
          "generalAlertAufnahmeAntrag",
          1,
          "aufnahmeantrag-TAN",
        );
      });
    </script>
  </body>
</html>
